name: Fork & Edit

on:
  workflow_dispatch:
  schedule:
    - cron: "30 * * * *"
  
jobs:
  Fork-FLITER-list:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Shanghai'
      REPO_PATH: 'esdeath-repo'
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4.1.0
      with:
        repository: hchichi/esdeath
        path: ${{ env.REPO_PATH }}

    - name: Copy GeoIP Files
      run: |
        mkdir -p $REPO_PATH/GeoIP
        
        # Download GeoIP databases
        curl -L -o "$REPO_PATH/GeoIP/CN_Country.mmdb" "https://raw.githubusercontent.com/Masaiki/GeoIP2-CN/release/Country.mmdb"
        curl -L -o "$REPO_PATH/GeoIP/Global_Country.mmdb" "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/Country.mmdb"
        curl -L -o "$REPO_PATH/GeoIP/IPInfo_Country.mmdb" "https://github.com/xream/geoip/releases/latest/download/ipinfo.country.mmdb"
        curl -L -o "$REPO_PATH/GeoIP/IP2Location_Country.mmdb" "https://github.com/xream/geoip/releases/latest/download/ip2location.country.mmdb"

    - name: Copy Surge Rules
      run: |
        # Create directory structure including CDN
        mkdir -p $REPO_PATH/Surge/Ruleset/{Apple,AI,Social,Google,Microsoft,Oracle,Streaming/{Video,Music},Reject,Direct,IPCIDR,Anti/{Apps,Direct,Proxy,Reject},GFW,Domestic,CCC-Global,CDN}
        
        # IPCIDR Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/IPCIDR/IPv4.China.list" "https://raw.githubusercontent.com/missuo/ASN-China/main/IP.China.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/IPCIDR/IPv6.China.list" "https://raw.githubusercontent.com/missuo/ASN-China/main/IPv6.China.list"

        # CCC Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/CCC-Global/Akamai.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/CCC-Global/Akamai.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/CCC-Global/Amazon.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/CCC-Global/Amazon.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/CCC-Global/CloudFlare.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/CCC-Global/CloudFlare.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/CCC-Global/HiNet.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/CCC-Global/HiNet.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/CCC-Global/VerizonMediaPlatform.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/CCC-Global/VerizonMediaPlatform.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/CCC-Global.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/CCC-Global.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/CCC-CN.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/CCC-CN.list"
        
        # SpeedTest Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/SpeedTest.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/SpeedTest.list"
        
        # Apple Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Apple/APNs.list" "https://proxyresource.pages.dev/Tool/Loon/Rule/ApplePushNotificationService.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Apple/Apple.list" "https://raw.githubusercontent.com/NobyDa/Script/master/Surge/Apple.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Apple/AppStore.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/source/rule/AppStore/AppStore.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Apple/AppleID.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/AppleID/AppleID.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Apple/AppleMusic.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/AppleMusic/AppleMusic.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Apple/iCloud.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/iCloud/iCloud.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Apple/TestFlight.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/TestFlight/TestFlight.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Apple/AppleProxy.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/AppleProxy/AppleProxy.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Apple/AppleMedia.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/AppleMedia/AppleMedia.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Apple/FitnessPlus.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/FitnessPlus/FitnessPlus.list"

        # AI Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/AI/OpenAI.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/refs/heads/master/Clash/Rules/OpenAi.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/AI/Claude.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Rules/Claude.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/AI/AI.list" "https://ruleset.skk.moe/List/non_ip/ai.conf"

        # Social Media Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Social/Twitter.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Rules/Twitter.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Social/Instagram.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Rules/Instagram.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Social/Facebook.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Rules/Facebook.list"

        # Google Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Google/Google.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Rules/Google.list"

        # Microsoft Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Microsoft/Github.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Rules/Github.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Microsoft/OneDrive.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Rules/OneDrive.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Microsoft/Microsoft.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Rules/Microsoft.list"

        # Development Rules
        #curl -L -o "$REPO_PATH/Surge/Ruleset/PROXY/Github.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/PROXY/Github.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/PROXY/Gitlab.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/PROXY/Gitlab.list"

        # Oracle Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Oracle/Oracle.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Oracle/Oracle.list"

        # Streaming Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/CN.list" "https://github.com/ConnersHua/RuleGo/raw/master/Surge/Rules/Extra/Streaming/CN.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/!CN.list" "https://github.com/ConnersHua/RuleGo/raw/master/Surge/Rules/Extra/Streaming/!CN.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/BiliBiliIntl.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/BiliBiliIntl/BiliBiliIntl.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Music/NetEaseMusic.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/Domestic-Services/NeteaseMusic.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/Bilibili.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Rules/Bilibili.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/TikTok.list" "https://proxyresource.pages.dev/Tool/Loon/Rule/TikTok.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/Netflix.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Netflix.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/HBO.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/HBO/HBO.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/Disney.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Disney/Disney.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Music/Spotify.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Spotify/Spotify.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/PrimeVideo.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/PrimeVideo/PrimeVideo.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/AppleMedia.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/AppleMedia/AppleMedia.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/Bahamut.list" "https://github.com/ACL4SSR/ACL4SSR/raw/master/Clash/Ruleset/Bahamut.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/ProxyMedia.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyMedia.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/YouTube.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Rules/YouTube.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/GlobalMedia.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/GlobalMedia.list"
        
        # Custom Emby Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/EmbyTemp1.list" "https://github.com/1120109856/lynn/raw/main/fxw"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Streaming/Video/EmbyTemp2.list" "https://github.com/1120109856/lynn/raw/main/zl"
        cat "$REPO_PATH/Surge/Ruleset/Streaming/Video/EmbyTemp1.list" "$REPO_PATH/Surge/Ruleset/Streaming/Video/EmbyTemp2.list" | sort -u > "$REPO_PATH/Surge/Ruleset/Streaming/Video/EmbyTest.list"
        rm "$REPO_PATH/Surge/Ruleset/Streaming/Video/EmbyTemp1.list" "$REPO_PATH/Surge/Ruleset/Streaming/Video/EmbyTemp2.list"

        # GFW Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/ProxyGFW.list" "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyGFWlist.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Foreign.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/PROXY.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Proxy.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Proxy/Proxy.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Global.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Global/Global.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/CDN.list" "https://ruleset.skk.moe/List/domainset/cdn.conf"
        curl -L -o "$REPO_PATH/Surge/Ruleset/CDN_NoIP.list" "https://ruleset.skk.moe/List/non_ip/cdn.conf"

        # Domestic Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Domestic/WeChat.list" "https://raw.githubusercontent.com/NobyDa/Script/master/Surge/WeChat.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Domestic/ChinaASN.list" "https://raw.githubusercontent.com/VirgilClyne/GetSomeFries/main/Rules/ASN.China.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Domestic/ChinaDomain.list" "https://ruleset.skk.moe/List/non_ip/domestic.conf"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Domestic/China.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/China/China.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Domestic/ChinaMax.list" "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/ChinaMax/ChinaMax.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Domestic/cn.list" "https://raw.githubusercontent.com/Blankwonder/surge-list/master/cn.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Domestic/Domestic.list" "https://raw.githubusercontent.com/LM-Firefly/Rules/master/Domestic.list"

        # Reject Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/Advertising.list" "https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Rules/Extra/Reject/Advertising.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/Hijacking.list" "https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Rules/Extra/Reject/Hijacking.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/Tracking.list" "https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Rules/Extra/Reject/Tracking.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/Ads_EasyListChina.list" "https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/rule/Surge/easylistchina_surge.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/Ads_EasyListPrivacy.list" "https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/rule/Surge/easyprivacy_surge.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/Ads_Dlerio.list" "https://raw.githubusercontent.com/dler-io/Rules/main/Surge/Surge%203/Provider/Reject.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/Ads_AWAvenue.list" "https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Surge.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/AdGuardChinese.list" "https://raw.githubusercontent.com/geekdada/surge-list/master/domain-set/chinese-filter.txt"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/Ads_fmz200.list" "https://raw.githubusercontent.com/fmz200/wool_scripts/main/QuantumultX/filter/fenliu.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/Ads_SukkaW.list" "https://ruleset.skk.moe/List/domainset/reject.conf"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Reject/Ads_SukkaW_NoIP.list" "https://ruleset.skk.moe/List/non_ip/reject.conf"

        # Anti-IP Attribution Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Anti/Direct/Direct.list" "https://github.com/SunsetMkt/anti-ip-attribution/raw/main/generated/rule-set-direct.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Anti/Proxy/Proxy.list" "https://github.com/SunsetMkt/anti-ip-attribution/raw/main/generated/rule-set-proxy.list"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Anti/Reject/Reject.list" "https://github.com/SunsetMkt/anti-ip-attribution/raw/main/generated/rule-set-reject.list"

        # Anti-IP Attribution App Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Anti/Apps/QQMusic.list" "https://github.com/SunsetMkt/anti-ip-attribution/raw/main/rules/QQ%E9%9F%B3%E4%B9%90.yaml"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Anti/Apps/Bilibili.list" "https://github.com/SunsetMkt/anti-ip-attribution/raw/main/rules/%E5%93%94%E5%93%A9%E5%93%A9.yaml"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Anti/Apps/Xiaohongshu.list" "https://github.com/SunsetMkt/anti-ip-attribution/raw/main/rules/%E5%B0%8F%E7%BA%A2%E4%B9%A6.yaml"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Anti/Apps/Douban.list" "https://github.com/SunsetMkt/anti-ip-attribution/raw/main/rules/%E8%B1%86%E7%93%A3.yaml"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Anti/Apps/NeteaseMusic.list" "https://github.com/SunsetMkt/anti-ip-attribution/raw/main/rules/%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90.yaml"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Anti/Apps/WeChat.list" "https://github.com/SunsetMkt/anti-ip-attribution/raw/main/rules/%E5%BE%AE%E4%BF%A1.yaml"
        curl -L -o "$REPO_PATH/Surge/Ruleset/Anti/Apps/Douyin.list" "https://github.com/SunsetMkt/anti-ip-attribution/raw/main/rules/%E6%8A%96%E9%9F%B3.yaml"

        # Lan Rules
        curl -L -o "$REPO_PATH/Surge/Ruleset/Lan.list" "https://raw.githubusercontent.com/Repcz/Tool/X/Surge/Rules/Lan.list"

    - name: Edit Rules
      run: |
        cd $REPO_PATH/Surge/Ruleset
        for file in *.list; do
          if [ -f "$file" ] && [ "$file" != "Lan.list" ]; then
            sed -i -e 's/, /,/g' \
                   -e 's/;/# /g' \
                   -e 's/host,/HOST,/g' \
                   -e 's/host-/HOST-/g' \
                   -e 's/-suffix/-SUFFIX/g' \
                   -e 's/-keyword/-KEYWORD/g' \
                   -e 's/ip-cidr/IP-CIDR/g' \
                   -e 's/-wildcard/-WILDCARD/g' \
                   -e 's/geoip/GEOIP/g' \
                   -e 's/HOST,/DOMAIN,/g' \
                   -e 's/HOST-/DOMAIN-/g' \
                   -e 's/IP6-CIDR,/IP-CIDR6,/g' \
                   -e 's/,REJECT$//g' \
                   -e 's/,DIRECT$//g' \
                   -e 's/,reject$//g' \
                   -e 's/,direct$//g' \
                   -e '/# 更新：/d' \
                   -e '/# AUTHOR:/d' \
                   -e '/# REPO:/d' \
                   -e '/# UPDATED:/d' \
                   -e '/# 数目: /d' \
                   -e '/# 规则: /d' \
                   -e '/404: Not Found/d' \
                   "$file"
            # 如果为IP规则且不包含no-resolve 则添加no-resolve
            awk '/^IP-/ && !/,no-resolve/ {print $0",no-resolve"; next} {print}' "$file" > tmpfile
            mv tmpfile "$file"
          fi
        done

        # 转换 domain-set 为 rule-set
        for file in AdGuardChinese.list Ads_AWAvenue.list Ads_SukkaW.list CDN.list; do
          if [ -f "$file" ]; then
            # 将以.开头的行的第一个.替换为 DOMAIN-SUFFIX,
            sed -i '/^\./s/^\./DOMAIN-SUFFIX,/' "$file"
            # 将除了以#开头、空行和以DOMAIN-SUFFIX开头之外的行，在行首添加 DOMAIN,
            sed -i '/^\s*$/b; /^\s*#/b; /^DOMAIN-SUFFIX,/b; s/^\([^#]\)/DOMAIN,\1/' "$file"
          else
            echo "$file not found."
          fi
        done

      # 追加规则
    - name: Copy custom rules
      run: |
        cd $REPO_PATH/Surge/Ruleset
        
        # Create empty files if they don't exist
        touch Reject/Reject.list
        touch CDN/CDN.list
        touch Reject/Ads_SukkaW.list

        # Merge Reject rules
        if [ -f "Reject/Reject.list" ]; then
          cat Reject/Advertising.list >> Reject/Reject.list
          cat Reject/Hijacking.list >> Reject/Reject.list
          cat Reject/Tracking.list >> Reject/Reject.list
        fi

        # Merge SukkaW rules
        if [ -f "Reject/Ads_SukkaW.list" ] && [ -f "Reject/Ads_SukkaW_NoIP.list" ]; then
          cat Reject/Ads_SukkaW_NoIP.list >> Reject/Ads_SukkaW.list
          rm -f Reject/Ads_SukkaW_NoIP.list
        fi

        # Merge CDN rules
        if [ -f "CDN/CDN.list" ] && [ -f "CDN/CDN_NoIP.list" ]; then
          cat CDN/CDN_NoIP.list >> CDN/CDN.list
          rm -f CDN/CDN_NoIP.list
        fi

      # 去重排序
    - name: Remove duplicates and lines 
      run: |
        cd $REPO_PATH/Surge/Ruleset
        shopt -s nullglob
        for file in Reject/Reject.list CDN/CDN.list; do
          if [ -f "$file" ]; then
            sorted_file="sorted_${file}"
            grep -v '^\s*#' "$file" | grep -v '^\s*$' | sort -u > "$sorted_file"
            mv "$sorted_file" "$file"
          fi
        done
      shell: bash

    - name: Merge Rules
      run: |
        cd $REPO_PATH/Surge/Ruleset
        
        # Ensure target files exist
        touch Reject/Reject.list
        touch CDN/CDN.list
        
        # Merge reject rules
        if [ -f "Reject/Reject.list" ]; then
          cat Reject/*.list > Reject/merged_reject.list
          mv Reject/merged_reject.list Reject/Reject.list
        fi

        # Merge CDN rules
        if [ -f "CDN/CDN.list" ]; then
          cat CDN/*.list > CDN/merged_cdn.list
          mv CDN/merged_cdn.list CDN/CDN.list
        fi

    - name: Clean and Sort Rules
      run: |
        cd $REPO_PATH/Surge/Ruleset
        for file in **/*.list; do
          if [ -f "$file" ]; then
            grep -v '^\s*#' "$file" | grep -v '^\s*$' | sort -u > "${file}.tmp"
            mv "${file}.tmp" "$file"
          fi
        done

    - name: Commit Changes
      run: |
        cd $REPO_PATH
        if [[ -n $(git status -s) ]]; then
          git config --local user.email "rin.tohsaka@fate-stay-night.com"
          git config --local user.name "Rin Tohsaka"
          git add .
          git commit -m "✨ Auto Update by Rin $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')"
          git push origin HEAD
        fi

    - name: Cleanup Workflow Runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 2